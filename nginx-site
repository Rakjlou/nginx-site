#!/usr/bin/env bash

# nginx-site - Manage nginx-based websites with dedicated system users
# Version: 1.0.0

set -euo pipefail

# Configuration
SITES_ENABLED_DIR="/etc/nginx/sites-enabled"
SYSTEMD_DIR="/etc/systemd/system"
PORT_RANGE_START=3000
PORT_RANGE_END=4000
DRY_RUN=false

# Main domain for subdomains (REQUIRED - set this to your domain)
# All created sites will be subdomains of this domain
# Example: If MAIN_DOMAIN="example.com", creating "blog" will create "blog.example.com"
MAIN_DOMAIN="${NGINX_SITE_DOMAIN:-}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ============================================================================
# Helper Functions
# ============================================================================

# Print colored messages
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_dry_run() {
    echo -e "${CYAN}[DRY-RUN]${NC} $1"
}

# Execute command or echo it in dry-run mode
run_cmd() {
    if [[ "$DRY_RUN" == "true" ]]; then
        print_dry_run "$*"
    else
        "$@"
    fi
}

# Extract project name from git repository URL
extract_project_name() {
    local repo_url="$1"
    # Remove .git suffix and extract last path component
    basename "$repo_url" .git
}

# Check if user exists
user_exists() {
    id "$1" &>/dev/null
}

# Check if project exists (based on user existence)
project_exists() {
    user_exists "$1"
}

# Get project type (static or app)
get_project_type() {
    local project="$1"
    local service_file="${SYSTEMD_DIR}/${project}.service"

    if [[ -f "$service_file" ]]; then
        echo "app"
    else
        echo "static"
    fi
}

# Find available port in range
find_available_port() {
    local port
    for port in $(seq $PORT_RANGE_START $PORT_RANGE_END); do
        if ! ss -tlnp 2>/dev/null | grep -q ":${port} "; then
            echo "$port"
            return 0
        fi
    done
    return 1
}

# Generate nginx configuration for static site
generate_static_nginx_config() {
    local domain="$1"
    local project="$2"

    cat <<EOF
server {
    listen 80;
    listen [::]:80;
    server_name ${domain};

    root /home/${project}/site;
    index index.html;

    location / {
        try_files \$uri \$uri/ \$uri.html =404;
    }

    access_log /home/${project}/logs/access.log;
    error_log /home/${project}/logs/error.log;
}
EOF
}

# Generate nginx configuration for application site
generate_app_nginx_config() {
    local domain="$1"
    local project="$2"
    local port="$3"

    cat <<EOF
server {
    listen 80;
    listen [::]:80;
    server_name ${domain};

    location / {
        proxy_pass http://127.0.0.1:${port};
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header X-Forwarded-Host \$host;
        proxy_buffering off;

        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        proxy_send_timeout 300s;

        client_max_body_size 100M;
    }

    access_log /home/${project}/logs/access.log;
    error_log /home/${project}/logs/error.log;
}
EOF
}

# Generate systemd service file for application
generate_systemd_service() {
    local project="$1"
    local command="$2"

    cat <<EOF
[Unit]
Description=${project} application service
After=network.target

[Service]
ExecStart=${command}
WorkingDirectory=/home/${project}/site
EnvironmentFile=/home/${project}/config/.env
User=${project}
Group=${project}
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
}

# Create project directory structure
create_directory_structure() {
    local project="$1"
    local home_dir="/home/${project}"

    print_info "Creating directory structure at ${home_dir}"

    run_cmd mkdir -p "${home_dir}"/{config,site,logs}
    run_cmd chown -R "${project}:${project}" "${home_dir}"
    run_cmd chmod 755 "${home_dir}"
}

# Clone git repository
clone_repository() {
    local project="$1"
    local repo_url="$2"
    local site_dir="/home/${project}/site"

    print_info "Cloning repository: ${repo_url}"

    # Remove site directory if it exists and is empty
    if [[ -d "$site_dir" ]] && [[ "$DRY_RUN" == "false" ]]; then
        rmdir "$site_dir" 2>/dev/null || true
    fi

    run_cmd sudo -u "$project" git clone "$repo_url" "$site_dir"
}

# Display summary after creation
display_creation_summary() {
    local project="$1"
    local site_type="$2"
    local domain="$3"

    echo ""
    print_success "Project '${project}' created successfully!"
    echo ""
    echo "Created files:"
    echo "  - /home/${project}/config/nginx.conf"
    echo "  - /etc/nginx/sites-enabled/${project} (symlink)"

    if [[ "$site_type" == "app" ]]; then
        echo "  - /etc/systemd/system/${project}.service"
        echo "  - /home/${project}/config/.env"
    fi

    echo ""
    echo "Next steps:"

    if [[ "$site_type" == "app" ]]; then
        echo "  1. Edit /home/${project}/config/.env to add environment variables"
        echo "  2. Install application dependencies in /home/${project}/site"
        echo "  3. Run: nginx-site start ${project}"
    else
        echo "  1. Ensure static files are in /home/${project}/site"
        echo "  2. Run: nginx-site start ${project}"
    fi

    echo ""
    echo "Your site will be available at: http://${domain}"
}

# ============================================================================
# Command: create static
# ============================================================================

cmd_create_static() {
    local subdomain=""
    local repo_url=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --repo)
                repo_url="$2"
                shift 2
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            *)
                if [[ -z "$subdomain" ]]; then
                    subdomain="$1"
                    shift
                else
                    print_error "Unknown argument: $1"
                    exit 1
                fi
                ;;
        esac
    done

    # Validate required arguments
    if [[ -z "$subdomain" ]] || [[ -z "$repo_url" ]]; then
        print_error "Usage: nginx-site create static <subdomain> --repo <git-url> [--dry-run]"
        exit 1
    fi

    # Check main domain is configured
    if [[ -z "$MAIN_DOMAIN" ]]; then
        print_error "MAIN_DOMAIN not configured. Set it in the script or via NGINX_SITE_DOMAIN environment variable."
        exit 1
    fi

    # Construct full domain
    local domain="${subdomain}.${MAIN_DOMAIN}"

    # Extract project name
    local project
    project=$(extract_project_name "$repo_url")

    print_info "Creating static site: ${domain}"
    print_info "Project name: ${project}"

    # Check if project already exists
    if project_exists "$project"; then
        print_error "Project '${project}' already exists (user exists)"
        exit 1
    fi

    # Confirmation
    echo ""
    echo "Summary:"
    echo "  Type: Static site"
    echo "  Subdomain: ${subdomain}"
    echo "  Full domain: ${domain}"
    echo "  Project: ${project}"
    echo "  Repository: ${repo_url}"
    echo ""

    if [[ "$DRY_RUN" == "false" ]]; then
        read -p "Continue? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "Cancelled"
            exit 0
        fi
    fi

    # Create system user
    print_info "Creating system user: ${project}"
    run_cmd useradd -r -m -d "/home/${project}" -s /bin/bash "$project"

    # Create directory structure
    create_directory_structure "$project"

    # Clone repository
    clone_repository "$project" "$repo_url"

    # Generate nginx configuration
    print_info "Generating nginx configuration"
    local nginx_config="/home/${project}/config/nginx.conf"

    if [[ "$DRY_RUN" == "true" ]]; then
        print_dry_run "Would write to ${nginx_config}:"
        echo "---"
        generate_static_nginx_config "$domain" "$project"
        echo "---"
    else
        generate_static_nginx_config "$domain" "$project" > "$nginx_config"
        chown "${project}:${project}" "$nginx_config"
    fi

    # Symlink nginx config
    print_info "Symlinking nginx configuration"
    run_cmd ln -sf "$nginx_config" "${SITES_ENABLED_DIR}/${project}"

    # Setup SSL with certbot
    print_info "Setting up SSL certificate with certbot"
    if [[ "$DRY_RUN" == "true" ]]; then
        print_dry_run "certbot --nginx -d $domain --non-interactive --agree-tos --register-unsafely-without-email"
    else
        certbot --nginx -d "$domain" --non-interactive --agree-tos --register-unsafely-without-email || {
            print_warning "Certbot failed or requires manual intervention"
        }
    fi

    # Display summary
    display_creation_summary "$project" "static" "$domain"
}

# ============================================================================
# Command: create app
# ============================================================================

cmd_create_app() {
    local subdomain=""
    local repo_url=""
    local port=""
    local start_command=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --repo)
                repo_url="$2"
                shift 2
                ;;
            --port)
                port="$2"
                shift 2
                ;;
            --start)
                start_command="$2"
                shift 2
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            *)
                if [[ -z "$subdomain" ]]; then
                    subdomain="$1"
                    shift
                else
                    print_error "Unknown argument: $1"
                    exit 1
                fi
                ;;
        esac
    done

    # Validate required arguments
    if [[ -z "$subdomain" ]] || [[ -z "$repo_url" ]] || [[ -z "$start_command" ]]; then
        print_error "Usage: nginx-site create app <subdomain> --repo <git-url> --start \"<command>\" [--port <port>] [--dry-run]"
        exit 1
    fi

    # Check main domain is configured
    if [[ -z "$MAIN_DOMAIN" ]]; then
        print_error "MAIN_DOMAIN not configured. Set it in the script or via NGINX_SITE_DOMAIN environment variable."
        exit 1
    fi

    # Construct full domain
    local domain="${subdomain}.${MAIN_DOMAIN}"

    # Auto-detect port if not provided
    if [[ -z "$port" ]]; then
        print_info "No port specified, auto-detecting available port..."
        port=$(find_available_port)
        if [[ -z "$port" ]]; then
            print_error "No available ports found in range ${PORT_RANGE_START}-${PORT_RANGE_END}"
            exit 1
        fi
        print_info "Using port: ${port}"
    fi

    # Extract project name
    local project
    project=$(extract_project_name "$repo_url")

    print_info "Creating application site: ${domain}"
    print_info "Project name: ${project}"

    # Check if project already exists
    if project_exists "$project"; then
        print_error "Project '${project}' already exists (user exists)"
        exit 1
    fi

    # Confirmation
    echo ""
    echo "Summary:"
    echo "  Type: Application site"
    echo "  Subdomain: ${subdomain}"
    echo "  Full domain: ${domain}"
    echo "  Project: ${project}"
    echo "  Repository: ${repo_url}"
    echo "  Port: ${port}"
    echo "  Start command: ${start_command}"
    echo ""

    if [[ "$DRY_RUN" == "false" ]]; then
        read -p "Continue? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "Cancelled"
            exit 0
        fi
    fi

    # Create system user
    print_info "Creating system user: ${project}"
    run_cmd useradd -r -m -d "/home/${project}" -s /bin/bash "$project"

    # Create directory structure
    create_directory_structure "$project"

    # Clone repository
    clone_repository "$project" "$repo_url"

    # Create .env file
    print_info "Creating .env file"
    local env_file="/home/${project}/config/.env"

    if [[ "$DRY_RUN" == "true" ]]; then
        print_dry_run "Would write to ${env_file}:"
        echo "---"
        cat <<EOF
# Environment variables for ${project}
# Add your configuration here
PORT=${port}
EOF
        echo "---"
    else
        cat > "$env_file" <<EOF
# Environment variables for ${project}
# Add your configuration here
PORT=${port}
EOF
        chown "${project}:${project}" "$env_file"
        chmod 600 "$env_file"
    fi

    # Generate nginx configuration
    print_info "Generating nginx configuration"
    local nginx_config="/home/${project}/config/nginx.conf"

    if [[ "$DRY_RUN" == "true" ]]; then
        print_dry_run "Would write to ${nginx_config}:"
        echo "---"
        generate_app_nginx_config "$domain" "$project" "$port"
        echo "---"
    else
        generate_app_nginx_config "$domain" "$project" "$port" > "$nginx_config"
        chown "${project}:${project}" "$nginx_config"
    fi

    # Symlink nginx config
    print_info "Symlinking nginx configuration"
    run_cmd ln -sf "$nginx_config" "${SITES_ENABLED_DIR}/${project}"

    # Generate systemd service
    print_info "Generating systemd service"
    local service_file="${SYSTEMD_DIR}/${project}.service"

    if [[ "$DRY_RUN" == "true" ]]; then
        print_dry_run "Would write to ${service_file}:"
        echo "---"
        generate_systemd_service "$project" "$start_command"
        echo "---"
    else
        generate_systemd_service "$project" "$start_command" > "$service_file"
    fi

    # Reload systemd
    run_cmd systemctl daemon-reload

    # Setup SSL with certbot
    print_info "Setting up SSL certificate with certbot"
    if [[ "$DRY_RUN" == "true" ]]; then
        print_dry_run "certbot --nginx -d $domain --non-interactive --agree-tos --register-unsafely-without-email"
    else
        certbot --nginx -d "$domain" --non-interactive --agree-tos --register-unsafely-without-email || {
            print_warning "Certbot failed or requires manual intervention"
        }
    fi

    # Display summary
    display_creation_summary "$project" "app" "$domain"
}

# ============================================================================
# Command: start
# ============================================================================

cmd_start() {
    local project=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            *)
                if [[ -z "$project" ]]; then
                    project="$1"
                    shift
                else
                    print_error "Unknown argument: $1"
                    exit 1
                fi
                ;;
        esac
    done

    if [[ -z "$project" ]]; then
        print_error "Usage: nginx-site start <project> [--dry-run]"
        exit 1
    fi

    if ! project_exists "$project"; then
        print_error "Project '${project}' does not exist"
        exit 1
    fi

    local project_type
    project_type=$(get_project_type "$project")

    # Start application service if it's an app
    if [[ "$project_type" == "app" ]]; then
        print_info "Enabling and starting ${project} service"
        run_cmd systemctl enable "${project}.service"
        run_cmd systemctl start "${project}.service"
    fi

    # Test and reload nginx
    print_info "Testing nginx configuration"
    run_cmd nginx -t

    print_info "Reloading nginx"
    run_cmd systemctl reload nginx

    print_success "Project '${project}' started successfully"
}

# ============================================================================
# Command: stop
# ============================================================================

cmd_stop() {
    local project=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            *)
                if [[ -z "$project" ]]; then
                    project="$1"
                    shift
                else
                    print_error "Unknown argument: $1"
                    exit 1
                fi
                ;;
        esac
    done

    if [[ -z "$project" ]]; then
        print_error "Usage: nginx-site stop <project> [--dry-run]"
        exit 1
    fi

    if ! project_exists "$project"; then
        print_error "Project '${project}' does not exist"
        exit 1
    fi

    local project_type
    project_type=$(get_project_type "$project")

    # Stop application service if it's an app
    if [[ "$project_type" == "app" ]]; then
        print_info "Stopping ${project} service"
        run_cmd systemctl stop "${project}.service"
        print_success "Project '${project}' stopped successfully"
    else
        print_warning "Project '${project}' is a static site (no service to stop)"
    fi
}

# ============================================================================
# Command: restart
# ============================================================================

cmd_restart() {
    local project=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            *)
                if [[ -z "$project" ]]; then
                    project="$1"
                    shift
                else
                    print_error "Unknown argument: $1"
                    exit 1
                fi
                ;;
        esac
    done

    if [[ -z "$project" ]]; then
        print_error "Usage: nginx-site restart <project> [--dry-run]"
        exit 1
    fi

    if ! project_exists "$project"; then
        print_error "Project '${project}' does not exist"
        exit 1
    fi

    local project_type
    project_type=$(get_project_type "$project")

    # Restart application service if it's an app
    if [[ "$project_type" == "app" ]]; then
        print_info "Restarting ${project} service"
        run_cmd systemctl restart "${project}.service"
        print_success "Project '${project}' restarted successfully"
    else
        print_warning "Project '${project}' is a static site (no service to restart)"
    fi
}

# ============================================================================
# Command: status
# ============================================================================

cmd_status() {
    local project="$1"

    if [[ -z "$project" ]]; then
        print_error "Usage: nginx-site status <project>"
        exit 1
    fi

    if ! project_exists "$project"; then
        print_error "Project '${project}' does not exist"
        exit 1
    fi

    local project_type
    project_type=$(get_project_type "$project")

    echo "Project: ${project}"
    echo "Type: ${project_type}"
    echo ""

    # Show application service status if it's an app
    if [[ "$project_type" == "app" ]]; then
        print_info "Service status:"
        systemctl status "${project}.service" --no-pager || true
        echo ""
    fi

    # Test nginx configuration
    print_info "Nginx configuration test:"
    nginx -t 2>&1 | grep -E "(test|successful)" || true
}

# ============================================================================
# Command: list
# ============================================================================

cmd_list() {
    print_info "Managed projects:"
    echo ""

    # Find all nginx site configurations
    local found=0

    if [[ -d "$SITES_ENABLED_DIR" ]]; then
        for config in "$SITES_ENABLED_DIR"/*; do
            if [[ -L "$config" ]]; then
                local project
                project=$(basename "$config")

                # Verify project user exists
                if project_exists "$project"; then
                    local project_type
                    project_type=$(get_project_type "$project")

                    local status="N/A"
                    if [[ "$project_type" == "app" ]]; then
                        if systemctl is-active --quiet "${project}.service"; then
                            status="${GREEN}running${NC}"
                        else
                            status="${RED}stopped${NC}"
                        fi
                    fi

                    echo -e "  ${BLUE}${project}${NC} (${project_type}) - ${status}"
                    found=1
                fi
            fi
        done
    fi

    if [[ $found -eq 0 ]]; then
        echo "  No projects found"
    fi
}

# ============================================================================
# Command: remove
# ============================================================================

cmd_remove() {
    local project=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            *)
                if [[ -z "$project" ]]; then
                    project="$1"
                    shift
                else
                    print_error "Unknown argument: $1"
                    exit 1
                fi
                ;;
        esac
    done

    if [[ -z "$project" ]]; then
        print_error "Usage: nginx-site remove <project> [--dry-run]"
        exit 1
    fi

    if ! project_exists "$project"; then
        print_error "Project '${project}' does not exist"
        exit 1
    fi

    local project_type
    project_type=$(get_project_type "$project")

    # Confirmation
    echo ""
    print_warning "This will remove:"
    echo "  - System user: ${project}"
    echo "  - Home directory: /home/${project}"
    echo "  - Nginx configuration: ${SITES_ENABLED_DIR}/${project}"

    if [[ "$project_type" == "app" ]]; then
        echo "  - Systemd service: ${SYSTEMD_DIR}/${project}.service"
    fi

    echo ""

    if [[ "$DRY_RUN" == "false" ]]; then
        read -p "Are you sure? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "Cancelled"
            exit 0
        fi
    fi

    # Stop and disable service if it's an app
    if [[ "$project_type" == "app" ]]; then
        print_info "Stopping and disabling ${project} service"
        if [[ "$DRY_RUN" == "true" ]]; then
            print_dry_run "systemctl stop ${project}.service"
            print_dry_run "systemctl disable ${project}.service"
        else
            systemctl stop "${project}.service" 2>/dev/null || true
            systemctl disable "${project}.service" 2>/dev/null || true
        fi

        print_info "Removing systemd service file"
        run_cmd rm -f "${SYSTEMD_DIR}/${project}.service"
        run_cmd systemctl daemon-reload
    fi

    # Remove nginx configuration symlink
    print_info "Removing nginx configuration"
    run_cmd rm -f "${SITES_ENABLED_DIR}/${project}"

    # Reload nginx
    if [[ "$DRY_RUN" == "true" ]]; then
        print_dry_run "nginx -t && systemctl reload nginx"
    else
        nginx -t && systemctl reload nginx
    fi

    # Remove home directory
    print_info "Removing home directory"
    run_cmd rm -rf "/home/${project}"

    # Remove system user
    print_info "Removing system user"
    run_cmd userdel "$project"

    print_success "Project '${project}' removed successfully"
}

# ============================================================================
# Command: config
# ============================================================================

cmd_config() {
    local project="$1"

    if [[ -z "$project" ]]; then
        print_error "Usage: nginx-site config <project>"
        exit 1
    fi

    if ! project_exists "$project"; then
        print_error "Project '${project}' does not exist"
        exit 1
    fi

    local project_type
    project_type=$(get_project_type "$project")

    echo "Configuration files for project: ${project}"
    echo ""
    echo "Nginx configuration:"
    echo "  /home/${project}/config/nginx.conf"
    echo "  ${SITES_ENABLED_DIR}/${project} (symlink)"
    echo ""

    if [[ "$project_type" == "app" ]]; then
        echo "Systemd service:"
        echo "  ${SYSTEMD_DIR}/${project}.service"
        echo ""
        echo "Environment file:"
        echo "  /home/${project}/config/.env"
        echo ""
    fi

    echo "Log files:"
    echo "  /home/${project}/logs/access.log"
    echo "  /home/${project}/logs/error.log"
    echo ""
    echo "Site directory:"
    echo "  /home/${project}/site"
}

# ============================================================================
# Main
# ============================================================================

main() {
    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        print_error "This script must be run as root"
        exit 1
    fi

    # Parse command
    if [[ $# -eq 0 ]]; then
        echo "nginx-site - Manage nginx-based websites"
        echo ""
        if [[ -n "$MAIN_DOMAIN" ]]; then
            echo "Main domain: ${MAIN_DOMAIN}"
            echo ""
        fi
        echo "Usage:"
        echo "  nginx-site create static <subdomain> --repo <git-url> [--dry-run]"
        echo "  nginx-site create app <subdomain> --repo <git-url> --start \"<command>\" [--port <port>] [--dry-run]"
        echo "  nginx-site start <project> [--dry-run]"
        echo "  nginx-site stop <project> [--dry-run]"
        echo "  nginx-site restart <project> [--dry-run]"
        echo "  nginx-site status <project>"
        echo "  nginx-site list"
        echo "  nginx-site remove <project> [--dry-run]"
        echo "  nginx-site config <project>"
        echo ""
        echo "Options:"
        echo "  --dry-run    Show what would be done without executing"
        echo ""
        if [[ -z "$MAIN_DOMAIN" ]]; then
            echo "NOTE: Set MAIN_DOMAIN in the script or via NGINX_SITE_DOMAIN environment variable"
        fi
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        create)
            if [[ $# -eq 0 ]]; then
                print_error "Usage: nginx-site create {static|app} ..."
                exit 1
            fi

            local subcommand="$1"
            shift

            case "$subcommand" in
                static)
                    cmd_create_static "$@"
                    ;;
                app)
                    cmd_create_app "$@"
                    ;;
                *)
                    print_error "Unknown create subcommand: $subcommand"
                    exit 1
                    ;;
            esac
            ;;
        start)
            cmd_start "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        restart)
            cmd_restart "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        remove)
            cmd_remove "$@"
            ;;
        config)
            cmd_config "$@"
            ;;
        *)
            print_error "Unknown command: $command"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
